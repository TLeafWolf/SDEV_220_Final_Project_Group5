{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<div class="header-container">
    <img src="{% static 'icons/header_image.jpg' %}" alt="Header Background" class="header-bg">
    <div class="header-content">
        <div class="header-left">
            <img src="{% static 'icons/TLeafLogo2sm.png' %}" alt="T Leaf Logo" class="logo">
            <div class="header-title">Pet Supplies</div>
        </div>
        <div class="header-subtitle">Inventory Management System</div>
        <div class="header-right">
            {% if user.is_authenticated %}
                <span>Welcome, {{ user.username }}</span>
                <a href="{% url 'logout' %}"><button type="button">Logout</button></a>
            {% else %}
                <a href="{% url 'login' %}"><button type="button">Login</button></a>
            {% endif %}
        </div>
    </div>
</div>

{% if low_stock_items %}
    <div class="warning">
        <h1>Warning</h1>
        <p>Some supplies are low in stock!</p>
        <a href="{% url 'index' %}?low_stock=true" class="filter-button">View Low Stock Items</a>
    </div>  
{% else %}
    <div class="status-message success">
        <p>All supplies are adequately stocked.</p>
    </div>
{% endif %}

<center>
<div class ="conmain">
    <div class="filter">
        <form method="get" style="margin-bottom: 1rem;">
            <input type="text" name="name" placeholder="Filter by name..." value="{{ name_query }}">
            <input type="text" name="location" placeholder="Filter by location..." value="{{ location_query }}" style="width: 110px;">
            <button type="submit">Filter</button>
            <a href="{% url 'index' %}"><button type="button">Reset</button></a>
 
        </form>
    </div>

    <center>
<div class="table-container">
    {% if user.is_authenticated %}
        <div class="action-bar">
            <a href="{% url 'add_supply' %}">
                <button type="button" class="add-button">Add New Supply</button>
            </a>
        </div>
    {% else %}
        <div class="login-notice">
            <strong>Please log in to add, edit, or delete supplies.</strong>
        </div>
    {% endif %}
    
    <div class="table-header">
        <table border="1" class="data_tab">
            <thead>
                <tr>
                    <th class="name_head">Name</th>
                    <th class="Price_head">Price</th>
                    <th class="Quan_head">Quantity</th>
                    <th class="loc_head">Location</th>
                    <th class="action_head">Actions</th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div class="table-body">
        <table border="1" class="data_tab">
            <tbody>
                {% for supply in supplies %}
                <tr {% if supply.quantity < 6 %}class="low-stock"{% endif %}>
                    <td class="name_row">{{ supply.name }}</td>
                    <td class="Price_row">${{ supply.price|floatformat:2 }}</td>
                    <td class="Quan_row">{{ supply.quantity }}</td>
                    <td class="loc_row">{{ supply.location }}</td>
                    <td class="action_row">
                        {% if user.is_authenticated %}
                            <div class="action-buttons">
                                <a href="{% url 'edit_supply' supply.name %}">
                                    <button type="button" class="edit-button">Edit</button>
                                </a>
                                <form action="{% url 'delete_supply' supply.name %}" method="post" class="delete-form" onsubmit="return confirmDelete();">
                                    {% csrf_token %}
                                    <button type="submit" class="delete-button">Delete</button>
                                </form>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="no-data">No supplies available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
</center>

{% if user.is_authenticated %}
<script>
    
        function editField(cell, fieldType, supplyName) {
    const display = cell.querySelector('.display');
    const input = cell.querySelector('.edit');

    display.style.display = 'none';
    input.style.display = 'inline';
    input.focus();

  
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            saveField(input, fieldType, supplyName);
        }
    });
}

function saveField(input, fieldType, supplyName) {
    const newValue = input.value;

   
    const formattedValue = `${parseFloat(newValue).toFixed(2)}`;


    input.style.display = 'none';
    const display = input.previousElementSibling;
    display.textContent = formattedValue; 
    display.style.display = 'inline';

    fetch(`/update_supply/${supplyName}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ [fieldType]: newValue })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        location.reload();
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}



    function confirmDelete() {
        return confirm("Are you sure you want to delete this item?");
    }
</script>
{% endif %}
<table class = "bottom_nav">
    <tr>
        <td>
        </td>
        {% if user.is_authenticated %}
        <td class = "blank"><a href="{% url 'audit_log' %}"><button type="button">Audit Log</button></a> </td>
        <td class = "export">

            {% endif %}
            {% if user.is_authenticated %}
            <a href="{% url 'export_supplies' %}">
                <button type="button">Export</button>
            </a>
        {% endif %}
        </td>
        <td class = "import">
        {% if user.is_authenticated %}
            <a href="{% url 'import_supplies' %}">
                <button type="button">Import</button>
            </a>
        {% endif %}
        </td>
    </tr>
</table>
</div>
</center>
</body>
</html>
