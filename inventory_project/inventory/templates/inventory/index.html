{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index Page</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
<style>


.data_tab th, .data_tab td {
    overflow: hidden;
    text-overflow: ellipsis; 
    white-space: nowrap; 
}

.edit {
    width: 100%; 
    box-sizing: border-box; 
}

</style>
    
</head>
<body>
    <div class="header-container">
        <table class = "nav_tab">
            <tr>
                <td>
    <img src="{% static 'icons/TLeafLogo2sm.png' %}" alt="T Leaf Logo">
</td>

 <td class = "pet">
    <div class = "head">
        Pet Supplies
        </div>
    </td>

<td class = "warn2">
    <center>
 Inventory Management System
</center>
</td>

<td class = "login">
    <a href="{% url 'login' %}"><button type="button">Login</button></a> 
</td>  
</tr>
</table>
</div>


{% if low_stock_items %}
    <div class='warning' style="color: red;">
        <center>
            <strong><h1>Warning:</h1></strong> Some supplies are low in stock!
            <a href="{% url 'index' %}?low_stock=true" class="filter-button">View</a>
        </center>
    </div>
{% else %}
    <div style="color: rgb(0, 0, 0);">
        <center>All supplies are adequately stocked.</center>
    </div>
{% endif %}

    <div class="filter">
        <form method="get" style="margin-bottom: 1rem;">
            <input type="text" name="name" placeholder="Filter by name..." value="{{ name_query }}">
            <input type="text" name="location" placeholder="Filter by location..." value="{{ location_query }}" style="width: 110px;">
            <button type="submit">Filter</button>
            <a href="{% url 'index' %}"><button type="button">Reset</button></a>
 
        </form>
    </div>

    <center>
<div class="table-container">
    <div class="table-header">
        <table border="1" class="data_tab">
            <thead>
                <tr>
                    <th class="name_head">Name</th>
                    <th class="Price_head">Price</th>
                    <th class="Quan_head">Quantity</th>
                    <th class="loc_head">Location</th>
                    <th class="edit_head"></th>
                   <th class="del_head">
                    <center>{% if user.is_authenticated %}
                        <a href="{% url 'add_supply' %}">
                            <button type="button">Add</button>
                        </a>
                        {% else %}
                        <div style="color: orange;">
                            <strong>Please log in to add, edit, or delete supplies.</strong>
                        </div>
                        {% endif %}</center> 
                    </th>
                </tr>
            </thead>
        </table>
    </div>
    <div class="table-body">
        <table border="1" class="data_tab">
            <tbody>
                {% for supply in supplies %}
                <tr {% if supply.quantity < 6 %}style="background-color: #ffcccc;"{% endif %}>
                    <td class="name_row">{{ supply.name }}</td>
                    <td class="Price_row" onclick="editField(this, 'price', '{{ supply.name }}')">
                        <span class="display">{{ supply.price|floatformat:2 }}</span>
                        <input type="text" class="edit" value="{{ supply.price|floatformat:2 }}" style="display:none;" onblur="saveField(this, 'price', '{{ supply.name }}')">
                    </td>
                    <td class="Quan_row" onclick="editField(this, 'quantity', '{{ supply.name }}')">
                        <span class="display">{{ supply.quantity }}</span>
                        <input type="text" class="edit" value="{{ supply.quantity }}" style="display:none;" onblur="saveField(this, 'quantity', '{{ supply.name }}')">
                    </td>
                    
                    <td class="loc_row" onclick="editField(this, 'location', '{{ supply.name }}')">
                        <span class="display">{{ supply.location }}</span>
                        <input type="text" class="edit" value="{{ supply.location }}" style="display:none;" onblur="saveField(this, 'location', '{{ supply.name }}')">
                    </td>
                    <td class='edit_button'>
                        <center>
                            {% if user.is_authenticated %}
                                <a href="{% url 'edit_supply' supply.name %}"><button type="button">Edit</button></a>
                            {% else %}
                                <span style="color: orange;">Login to edit</span>
                            {% endif %}
                        </center>
                    </td>
                    <td class='Del_button'>
                        <form action="{% url 'delete_supply' supply.name %}" method="post" style="display:inline;" onsubmit="return confirmDelete();">
                            {% csrf_token %}
                            {% if user.is_authenticated %}
                                <button type="submit">Delete</button>
                            {% else %}
                                <span style="color: orange;">Login to Delete</span>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">No supplies available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
</center>
<script>
        function editField(cell, fieldType, supplyName) {
        const display = cell.querySelector('.display');
        const input = cell.querySelector('.edit');
        
 
        display.style.display = 'none';
        input.style.display = 'inline';
        input.focus();
    }

    function saveField(input, fieldType, supplyName) {
    const newValue = input.value;

    // Show confirmation dialog
    if (confirm("Are you sure you want to commit this change?")) {
        input.style.display = 'none';
        const display = input.previousElementSibling;
        display.textContent = newValue;
        display.style.display = 'inline';

        fetch(`/update_supply/${supplyName}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ [fieldType]: newValue })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Refresh the page after a successful update
            location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    } else {
        // If the user cancels, revert the input field to its previous state
        input.style.display = 'none';
        const display = input.previousElementSibling;
        display.style.display = 'inline';
        }
    }

    function confirmDelete() {
        return confirm("Are you sure you want to delete this item?");
    }
</script>

<table class = "bottom_nav">
    <tr>
        <td>

</td>
<td class = "blank"><a href="{% url 'audit_log' %}"><button type="button">Audit Log</button></a> </td>
<td class = "export">
{% if user.is_authenticated %}
<a href="{% url 'export_supplies' %}">
    <button type="button">Export</button>
</a>
</td>
<td class = "import">
<a href="{% url 'import_supplies' %}">
    <button type="button">Import</button>
</a>
{% endif %}
</td>
</tr>
</table>


</body>
</html>
